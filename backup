#!/bin/bash
PATH=/bin:/usr/bin
[ -d "$BACKUP_EXECUTABLE_DIR" ] || BACKUP_EXECUTABLE_DIR=${0%/*}
source $BACKUP_EXECUTABLE_DIR/library.sh || exit 1

while [ "$1" ]; do 
	cmd=$1
	case "$cmd" in 
		-s|--settings)
			shift
			SETTINGS=$1
			;;
		-n|--dry-run)
			DRY_RUN=true
			VERBOSE=true
			;;
		-v|--verbose)
			VERBOSE=true
			;;
		-q|--quiet)
			unset VERBOSE
			;;
		*)
			ARGS="$ARGS $1"
	esac
	shift
done
source $BACKUP_EXECUTABLE_DIR/load-settings.sh || exit 1

function parse_command {
	cmd=$1
	case "$cmd" in 
		-e|--edit) $EDITOR $TARGETS ;;
		-lock|--lock)
			check_and_lock
			echo "All backups are locked; delete $SESSION/lock to unlock." 1>&2
			echo Backup has been explicitly locked. Delete this file to unlock. >$SESSION/lock
			trap '' EXIT
			exit ;;
		-*) die "Unrecognized command: $1" ;;
		*)
			check_and_lock
			$BACKUP_EXECUTABLE_DIR/run_profile $*
			;;
	esac;
}
parse_command $ARGS
